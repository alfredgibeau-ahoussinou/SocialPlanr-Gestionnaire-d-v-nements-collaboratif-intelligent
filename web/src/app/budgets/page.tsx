"use client"; import { useEffect, useState } from "react"; import ProtectedRoute from "@/components/ProtectedRoute"; import Navigation from "@/components/Navigation"; import Footer from "@/components/Footer"; import { useAuth } from "@/contexts/AuthContext"; import { collection, query, where, onSnapshot, addDoc, deleteDoc, doc } from "firebase/firestore"; import { db } from "@/config/firebase"; import { Budget } from "@/types"; export default function BudgetsPage() { const { user } = useAuth(); const [budgets, setBudgets] = useState<Budget[]>([]); const [loading, setLoading] = useState(true); const [showModal, setShowModal] = useState(false); const [formData, setFormData] = useState({ name: "", category: "other" as Budget["category"], limit: "", period: "monthly" as "monthly" | "yearly" | "custom", type: "personal" as "personal" | "business", startDate: new Date().toISOString().split("T")[0], endDate: "", }); useEffect(() => { if (!user) return; const budgetsQuery = query( collection(db, "budgets"), where("createdBy", "==", user.uid) ); const unsubscribe = onSnapshot(budgetsQuery, (snapshot) => { const budgetsData = snapshot.docs.map((doc) => ({ id: doc.id, ...doc.data(), startDate: doc.data().startDate?.toDate() || new Date(), endDate: doc.data().endDate?.toDate(), createdAt: doc.data().createdAt?.toDate() || new Date(), updatedAt: doc.data().updatedAt?.toDate() || new Date(), })) as Budget[]; setBudgets(budgetsData); setLoading(false); }); return unsubscribe; }, [user]); const handleCreateBudget = async (e: React.FormEvent) => { e.preventDefault(); if (!user) return; try { const limit = parseFloat(formData.limit); if (isNaN(limit) || limit <= 0) { alert("Limite invalide"); return; } await addDoc(collection(db, "budgets"), { name: formData.name, category: formData.category, limit, spent: 0, period: formData.period, type: formData.type, startDate: new Date(formData.startDate), endDate: formData.endDate ? new Date(formData.endDate) : null, createdBy: user.uid, status: "active", createdAt: new Date(), updatedAt: new Date(), }); setShowModal(false); setFormData({ name: "", category: "other", limit: "", period: "monthly", type: "personal", startDate: new Date().toISOString().split("T")[0], endDate: "", }); } catch (error) { console.error("Erreur lors de la création du budget:", error); alert("Erreur lors de la création du budget"); } }; const handleDelete = async (budgetId: string) => { if (!confirm("Êtes-vous sûr de vouloir supprimer ce budget ?")) return; try { await deleteDoc(doc(db, "budgets", budgetId)); } catch (error) { console.error("Erreur lors de la suppression:", error); } }; const categories = [ "food", "transport", "shopping", "bills", "entertainment", "health", "education", "travel", "other", ]; return ( <ProtectedRoute> <div className="min-h-screen bg-gradient-to-br from-stone-50 via-amber-50 to-amber-50"> <Navigation /> <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8"> <div className="flex items-center justify-between mb-8"> <div> <h1 className="text-3xl font-bold text-gray-900 mb-2">Mes budgets</h1> <p className="text-gray-600">Suivez vos budgets par catégorie</p> </div> <button onClick={() => setShowModal(true)} className="bg-gradient-to-r from-amber-700 to-stone-600 text-white px-6 py-3 rounded-lg font-semibold hover:shadow-lg transition-all" > + Créer un budget </button> </div> {loading ? ( <div className="text-center py-12"> <div className="w-16 h-16 border-4 border-amber-700 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div> <p className="text-gray-600">Chargement...</p> </div> ) : budgets.length === 0 ? ( <div className="bg-white rounded-xl shadow-lg p-12 text-center"> <p className="text-gray-500 mb-4">Aucun budget créé</p> <button onClick={() => setShowModal(true)} className="bg-amber-700 text-white px-6 py-3 rounded-lg font-semibold hover:bg-amber-800 transition-colors" > Créer votre premier budget </button> </div> ) : ( <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"> {budgets.map((budget) => { const percentage = (budget.spent / budget.limit) * 100; return ( <div key={budget.id} className="bg-white rounded-xl shadow-lg p-6"> <div className="flex items-center justify-between mb-4"> <h3 className="text-lg font-semibold text-gray-900">{budget.name}</h3> <button onClick={() => handleDelete(budget.id)} className="text-red-600 hover:text-red-700" > </button> </div> <div className="mb-4"> <div className="flex items-center justify-between mb-2"> <span className="text-sm text-gray-600">{budget.category}</span> <span className="text-sm font-semibold text-gray-900"> {budget.spent.toFixed(2)} / {budget.limit.toFixed(2)} € </span> </div> <div className="w-full bg-gray-200 rounded-full h-3"> <div className={`h-3 rounded-full transition-all ${ percentage > 100 ? "bg-red-600" : percentage > 80 ? "bg-yellow-600" : "bg-green-600" }`} style={{ width: `${Math.min(percentage, 100)}%` }} ></div> </div> <p className="text-xs text-gray-500 mt-1"> {percentage.toFixed(1)}% utilisé </p> </div> <div className="flex items-center justify-between"> <span className="text-xs bg-stone-100 text-amber-800 px-2 py-1 rounded"> {budget.type} </span> <span className="text-xs text-gray-500">{budget.period}</span> </div> </div> ); })} </div> )} {/* Modal de création */} {showModal && ( <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"> <div className="bg-white rounded-xl shadow-xl max-w-md w-full p-6"> <h2 className="text-2xl font-bold text-gray-900 mb-4">Créer un budget</h2> <form onSubmit={handleCreateBudget} className="space-y-4"> <div> <label className="block text-sm font-medium text-gray-700 mb-2">Nom</label> <input type="text" value={formData.name} onChange={(e) => setFormData({ ...formData, name: e.target.value })} required className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-600" placeholder="Budget mensuel" /> </div> <div> <label className="block text-sm font-medium text-gray-700 mb-2">Catégorie</label> <select value={formData.category} onChange={(e) => setFormData({ ...formData, category: e.target.value as Budget["category"] })} className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-600" > {categories.map((cat) => ( <option key={cat} value={cat}> {cat} </option> ))} </select> </div> <div> <label className="block text-sm font-medium text-gray-700 mb-2">Limite (€)</label> <input type="number" step="0.01" value={formData.limit} onChange={(e) => setFormData({ ...formData, limit: e.target.value })} required className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-600" placeholder="0.00" /> </div> <div> <label className="block text-sm font-medium text-gray-700 mb-2">Période</label> <select value={formData.period} onChange={(e) => setFormData({ ...formData, period: e.target.value as "monthly" | "yearly" | "custom" })} className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-600" > <option value="monthly">Mensuel</option> <option value="yearly">Annuel</option> <option value="custom">Personnalisé</option> </select> </div> <div> <label className="block text-sm font-medium text-gray-700 mb-2">Type</label> <select value={formData.type} onChange={(e) => setFormData({ ...formData, type: e.target.value as "personal" | "business" })} className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-600" > <option value="personal">Personnel</option> <option value="business">Professionnel</option> </select> </div> <div> <label className="block text-sm font-medium text-gray-700 mb-2">Date de début</label> <input type="date" value={formData.startDate} onChange={(e) => setFormData({ ...formData, startDate: e.target.value })} required className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-600" /> </div> {formData.period === "custom" && ( <div> <label className="block text-sm font-medium text-gray-700 mb-2">Date de fin</label> <input type="date" value={formData.endDate} onChange={(e) => setFormData({ ...formData, endDate: e.target.value })} className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-600" /> </div> )} <div className="flex space-x-4"> <button type="button" onClick={() => setShowModal(false)} className="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50" > Annuler </button> <button type="submit" className="flex-1 px-4 py-2 bg-amber-700 text-white rounded-lg hover:bg-amber-800" > Créer </button> </div> </form> </div> </div> )} </main> <Footer /> </div> </ProtectedRoute> ); } 