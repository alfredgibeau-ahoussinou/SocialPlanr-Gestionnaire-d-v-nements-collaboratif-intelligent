"use client"; import { useEffect, useState } from "react"; import ProtectedRoute from "@/components/ProtectedRoute"; import Navigation from "@/components/Navigation"; import Footer from "@/components/Footer"; import { useAuth } from "@/contexts/AuthContext"; import { collection, query, where, onSnapshot, addDoc } from "firebase/firestore"; import { db } from "@/config/firebase"; import { Transaction, Account } from "@/types"; export default function TransactionsPage() { const { user } = useAuth(); const [transactions, setTransactions] = useState<Transaction[]>([]); const [accounts, setAccounts] = useState<Account[]>([]); const [loading, setLoading] = useState(true); const [showModal, setShowModal] = useState(false); const [formData, setFormData] = useState({ accountId: "", type: "expense" as "income" | "expense", amount: "", category: "other" as Transaction["category"], description: "", date: new Date().toISOString().split("T")[0], }); useEffect(() => { if (!user) return; const transactionsQuery = query( collection(db, "transactions"), where("createdBy", "==", user.uid) ); const unsubscribeTransactions = onSnapshot(transactionsQuery, (snapshot) => { const transactionsData = snapshot.docs.map((doc) => ({ id: doc.id, ...doc.data(), date: doc.data().date?.toDate() || new Date(), createdAt: doc.data().createdAt?.toDate() || new Date(), updatedAt: doc.data().updatedAt?.toDate() || new Date(), })) as Transaction[]; setTransactions(transactionsData.sort((a, b) => b.date.getTime() - a.date.getTime())); setLoading(false); }); const accountsQuery = query( collection(db, "accounts"), where("createdBy", "==", user.uid) ); const unsubscribeAccounts = onSnapshot(accountsQuery, (snapshot) => { const accountsData = snapshot.docs.map((doc) => ({ id: doc.id, ...doc.data(), createdAt: doc.data().createdAt?.toDate() || new Date(), updatedAt: doc.data().updatedAt?.toDate() || new Date(), })) as Account[]; setAccounts(accountsData); if (accountsData.length > 0) { setFormData((prev) => { if (!prev.accountId) { return { ...prev, accountId: accountsData[0].id }; } return prev; }); } }); return () => { unsubscribeTransactions(); unsubscribeAccounts(); }; }, [user]); const handleCreateTransaction = async (e: React.FormEvent) => { e.preventDefault(); if (!user || !formData.accountId) return; try { const amount = parseFloat(formData.amount); if (isNaN(amount) || amount <= 0) { alert("Montant invalide"); return; } await addDoc(collection(db, "transactions"), { accountId: formData.accountId, type: formData.type, amount: formData.type === "expense" ? -Math.abs(amount) : Math.abs(amount), category: formData.category, description: formData.description, date: new Date(formData.date), createdBy: user.uid, createdAt: new Date(), updatedAt: new Date(), }); // Note: En production, utilisez une transaction Firestore pour garantir la cohérence // Le solde du compte sera mis à jour via les règles Firestore ou une fonction cloud setShowModal(false); setFormData({ accountId: accounts[0]?.id || "", type: "expense", amount: "", category: "other", description: "", date: new Date().toISOString().split("T")[0], }); } catch (error) { console.error("Erreur lors de la création de la transaction:", error); alert("Erreur lors de la création de la transaction"); } }; const totalIncome = transactions .filter((t) => t.type === "income") .reduce((sum, t) => sum + Math.abs(t.amount), 0); const totalExpenses = transactions .filter((t) => t.type === "expense") .reduce((sum, t) => sum + Math.abs(t.amount), 0); const categories = [ "salary", "freelance", "investment", "food", "transport", "shopping", "bills", "entertainment", "health", "education", "other", ]; return ( <ProtectedRoute> <div className="min-h-screen bg-gradient-to-br from-stone-50 via-amber-50 to-amber-50"> <Navigation /> <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8"> <div className="flex items-center justify-between mb-8"> <div> <h1 className="text-3xl font-bold text-gray-900 mb-2">Transactions</h1> <p className="text-gray-600">Gérez vos revenus et dépenses</p> </div> <button onClick={() => setShowModal(true)} className="bg-gradient-to-r from-amber-700 to-stone-600 text-white px-6 py-3 rounded-lg font-semibold hover:shadow-lg transition-all" > + Ajouter une transaction </button> </div> {/* Statistiques */} <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8"> <div className="bg-white rounded-xl shadow-lg p-6"> <h3 className="text-sm font-medium text-gray-600 mb-2">Total revenus</h3> <p className="text-3xl font-bold text-green-600">+{totalIncome.toFixed(2)} €</p> </div> <div className="bg-white rounded-xl shadow-lg p-6"> <h3 className="text-sm font-medium text-gray-600 mb-2">Total dépenses</h3> <p className="text-3xl font-bold text-red-600">-{totalExpenses.toFixed(2)} €</p> </div> </div> {loading ? ( <div className="text-center py-12"> <div className="w-16 h-16 border-4 border-amber-700 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div> <p className="text-gray-600">Chargement...</p> </div> ) : transactions.length === 0 ? ( <div className="bg-white rounded-xl shadow-lg p-12 text-center"> <p className="text-gray-500 mb-4">Aucune transaction</p> <button onClick={() => setShowModal(true)} className="bg-amber-700 text-white px-6 py-3 rounded-lg font-semibold hover:bg-amber-800 transition-colors" > Ajouter votre première transaction </button> </div> ) : ( <div className="bg-white rounded-xl shadow-lg overflow-hidden"> <div className="overflow-x-auto"> <table className="w-full"> <thead className="bg-gray-50"> <tr> <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th> <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Description</th> <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Catégorie</th> <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Type</th> <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Montant</th> </tr> </thead> <tbody className="divide-y divide-gray-200"> {transactions.map((transaction) => ( <tr key={transaction.id} className="hover:bg-gray-50"> <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900"> {transaction.date.toLocaleDateString("fr-FR")} </td> <td className="px-6 py-4 text-sm text-gray-900"> {transaction.description || transaction.category} </td> <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500"> {transaction.category} </td> <td className="px-6 py-4 whitespace-nowrap"> <span className={`px-2 py-1 text-xs rounded-full ${ transaction.type === "income" ? "bg-green-100 text-green-800" : "bg-red-100 text-red-800" }`} > {transaction.type === "income" ? "Revenu" : "Dépense"} </span> </td> <td className={`px-6 py-4 whitespace-nowrap text-sm font-semibold text-right ${ transaction.type === "income" ? "text-green-600" : "text-red-600" }`} > {transaction.type === "income" ? "+" : "-"} {Math.abs(transaction.amount).toFixed(2)} € </td> </tr> ))} </tbody> </table> </div> </div> )} {/* Modal de création */} {showModal && ( <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"> <div className="bg-white rounded-xl shadow-xl max-w-md w-full p-6"> <h2 className="text-2xl font-bold text-gray-900 mb-4">Nouvelle transaction</h2> <form onSubmit={handleCreateTransaction} className="space-y-4"> <div> <label className="block text-sm font-medium text-gray-700 mb-2">Type</label> <select value={formData.type} onChange={(e) => setFormData({ ...formData, type: e.target.value as "income" | "expense" })} className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-600" > <option value="expense">Dépense</option> <option value="income">Revenu</option> </select> </div> <div> <label className="block text-sm font-medium text-gray-700 mb-2">Compte</label> <select value={formData.accountId} onChange={(e) => setFormData({ ...formData, accountId: e.target.value })} required className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-600" > {accounts.map((acc) => ( <option key={acc.id} value={acc.id}> {acc.name} ({acc.balance.toFixed(2)} {acc.currency}) </option> ))} </select> </div> <div> <label className="block text-sm font-medium text-gray-700 mb-2">Montant</label> <input type="number" step="0.01" value={formData.amount} onChange={(e) => setFormData({ ...formData, amount: e.target.value })} required className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-600" placeholder="0.00" /> </div> <div> <label className="block text-sm font-medium text-gray-700 mb-2">Catégorie</label> <select value={formData.category} onChange={(e) => setFormData({ ...formData, category: e.target.value as Transaction["category"] })} className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-600" > {categories.map((cat) => ( <option key={cat} value={cat}> {cat} </option> ))} </select> </div> <div> <label className="block text-sm font-medium text-gray-700 mb-2">Description</label> <input type="text" value={formData.description} onChange={(e) => setFormData({ ...formData, description: e.target.value })} className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-600" placeholder="Description de la transaction" /> </div> <div> <label className="block text-sm font-medium text-gray-700 mb-2">Date</label> <input type="date" value={formData.date} onChange={(e) => setFormData({ ...formData, date: e.target.value })} required className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-600" /> </div> <div className="flex space-x-4"> <button type="button" onClick={() => setShowModal(false)} className="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50" > Annuler </button> <button type="submit" className="flex-1 px-4 py-2 bg-amber-700 text-white rounded-lg hover:bg-amber-800" > Ajouter </button> </div> </form> </div> </div> )} </main> <Footer /> </div> </ProtectedRoute> ); } 